name: Deploy to EC2

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

env:
  AWS_REGION: us-east-1
  SSH_HOST: ${{ secrets.EC2_HOST }}
  SSH_USER: ec2-user
  APP_DIR: /opt/app
  SSH_PORT: 22

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build
        env:
          NODE_ENV: production

      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          
          # Escrever a chave SSH
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          
          # Corrigir formatação
          sed -i 's/\\n/\n/g' ~/.ssh/deploy_key  # Converter \n para quebras de linha reais
          sed -i 's/\r$//' ~/.ssh/deploy_key     # Remover CRLF do Windows
          
          # Garantir que começa e termina corretamente
          if ! head -1 ~/.ssh/deploy_key | grep -q "BEGIN"; then
            echo "-----BEGIN RSA PRIVATE KEY-----" > ~/.ssh/deploy_key.tmp
            cat ~/.ssh/deploy_key >> ~/.ssh/deploy_key.tmp
            mv ~/.ssh/deploy_key.tmp ~/.ssh/deploy_key
          fi
          
          if ! tail -1 ~/.ssh/deploy_key | grep -q "END"; then
            echo "-----END RSA PRIVATE KEY-----" >> ~/.ssh/deploy_key
          fi
          
          # Adicionar newline final
          echo "" >> ~/.ssh/deploy_key
          
          chmod 600 ~/.ssh/deploy_key
          
          # Verificar a chave
          echo "=== Verificando chave SSH ==="
          echo "Linhas: $(wc -l ~/.ssh/deploy_key)"
          echo "Primeira linha: $(head -1 ~/.ssh/deploy_key)"
          echo "Última linha: $(tail -1 ~/.ssh/deploy_key)"
          
          # Testar se a chave é válida
          if ssh-keygen -y -f ~/.ssh/deploy_key > /dev/null 2>&1; then
            echo "✅ Chave SSH válida"
          else
            echo "❌ Chave SSH inválida"
            exit 1
          fi

      - name: Test SSH connection
        run: |
          echo "=== Testando conexão SSH ==="
          echo "Conectando em $SSH_USER@$SSH_HOST:$SSH_PORT"
          
          # Teste simples de porta
          timeout 5 nc -zv "$SSH_HOST" "$SSH_PORT" && echo "✅ Porta 22 acessível"
          
          # Teste SSH
          set +e  # Não sair no primeiro erro
          ssh_output=$(timeout 15 ssh \
            -o StrictHostKeyChecking=no \
            -o UserKnownHostsFile=/dev/null \
            -o ConnectTimeout=10 \
            -o LogLevel=ERROR \
            -i ~/.ssh/deploy_key \
            "$SSH_USER@$SSH_HOST" \
            "echo '✅ Conexão SSH bem-sucedida'; whoami; hostname" 2>&1)
          
          ssh_exit=$?
          
          if [ $ssh_exit -eq 0 ]; then
            echo "$ssh_output"
            echo "✅ SSH funcionando perfeitamente!"
          else
            echo "❌ Falha na conexão SSH"
            echo "Saída do SSH:"
            echo "$ssh_output"
            
            # Tentar com verbose para debug
            echo "=== DEBUG com verbose ==="
            timeout 10 ssh -vvv \
              -o ConnectTimeout=5 \
              -i ~/.ssh/deploy_key \
              "$SSH_USER@$SSH_HOST" \
              "echo test" 2>&1 | tail -50
            exit 1
          fi
      # Antes do deploy, edite o main.ts
      - name: Configure API to listen on all interfaces
        run: |
          cd /opt/app
          sed -i "s/await app\.listen(port)/await app.listen(port, '0.0.0.0')/" src/main.ts
          
      - name: Deploy to EC2
        run: |
          echo "=== Iniciando deploy ==="
          
          # Criar diretório da aplicação
          ssh -o StrictHostKeyChecking=no \
              -i ~/.ssh/deploy_key \
              "$SSH_USER@$SSH_HOST" \
              "sudo mkdir -p $APP_DIR && sudo chown -R $SSH_USER:$SSH_USER $APP_DIR"
          
          # Sincronizar arquivos
          echo "Sincronizando arquivos..."
          rsync -avz -e "ssh -o StrictHostKeyChecking=no -i ~/.ssh/deploy_key" \
            --exclude='.git' \
            --exclude='node_modules' \
            --exclude='.env' \
            ./ "$SSH_USER@$SSH_HOST:$APP_DIR/"
          
          # Executar deploy no servidor
          echo "Executando deploy no servidor..."
          ssh -o StrictHostKeyChecking=no \
              -i ~/.ssh/deploy_key \
              "$SSH_USER@$SSH_HOST" \
              "cd $APP_DIR && \
               npm ci --only=production && \
               echo 'Deploy concluído!'"
          
          echo "✅ Deploy finalizado com sucesso!"