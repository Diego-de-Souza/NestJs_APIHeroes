name: Deploy to EC2

on:
  push:
    branches: [main, master]

env:
  SSH_HOST: ${{ secrets.EC2_HOST }}
  SSH_USER: ec2-user
  APP_DIR: /opt/app

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Install NestJS CLI and dependencies
        run: |
          npm ci
          # Instalar Nest CLI globalmente para o build
          npm install -g @nestjs/cli
          
      - name: Build application
        run: npm run build
        env:
          NODE_ENV: production
          
      - name: Prepare deployment
        run: |
          # Corrigir estrutura do dist se necessÃ¡rio
          [ -f "dist/src/main.js" ] && mv dist/src/* dist/ && rmdir dist/src
          
          # Criar ecosystem.config
          cat > ecosystem.config.js << 'EOF'
          module.exports = {
            apps: [{
              name: 'app',
              script: './dist/main.js',
              instances: 1,
              autorestart: true,
              watch: false,
              env: {
                NODE_ENV: 'production'
              }
            }]
          }
          EOF
          
          # Criar diretÃ³rio temporÃ¡rio
          mkdir -p _deploy
          cp -r dist _deploy/
          cp package.json package-lock.json ecosystem.config.js _deploy/
          
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/key
          sed -i 's/\\\\n/\\n/g; s/\\n/\n/g' ~/.ssh/key
          chmod 600 ~/.ssh/key
          
      - name: Deploy
        run: |
          # Enviar arquivos
          rsync -avz -e "ssh -o StrictHostKeyChecking=no -i ~/.ssh/key" _deploy/ "$SSH_USER@$SSH_HOST:$APP_DIR/"
          
          # Configurar no EC2
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/key "$SSH_USER@$SSH_HOST" "
            cd $APP_DIR
            npm ci --only=production
            pm2 delete app 2>/dev/null || true
            pm2 start ecosystem.config.js
            echo 'ðŸš€ AplicaÃ§Ã£o iniciada!'
          "
          
      - name: Cleanup
        run: rm -rf _deploy ~/.ssh/key