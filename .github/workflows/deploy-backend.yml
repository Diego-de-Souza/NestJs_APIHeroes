name: Deploy to EC2

on:
  push:
    branches: [main, master]

env:
  SSH_HOST: ${{ secrets.EC2_HOST }}
  SSH_USER: ec2-user
  APP_DIR: /opt/app

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - run: npm ci && npm run build
        env:
          NODE_ENV: production
          
      - name: Fix dist structure
        run: |
          # Corrigir se main.js estÃ¡ em dist/src/
          if [ -f "dist/src/main.js" ]; then
            mv dist/src/* dist/ 2>/dev/null || true
            rmdir dist/src 2>/dev/null || true
          fi
          
      - name: Configure API to listen on all interfaces
        run: |
          if [ -f "src/main.ts" ]; then
            sed -i "s/await app\.listen(port)/await app.listen(port, '0.0.0.0')/g" src/main.ts
          fi
          
      - name: Create PM2 config
        run: |
          cat > ecosystem.config.js << 'EOF'
          module.exports = {
            apps: [{
              name: 'app',
              script: './dist/main.js',
              instances: 1,
              autorestart: true,
              watch: false,
              max_memory_restart: '500M',
              env: {
                NODE_ENV: 'production',
                PORT: 3000
              }
            }]
          }
          EOF
          
      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/key
          sed -i 's/\\n/\n/g' ~/.ssh/key
          chmod 600 ~/.ssh/key
          
      - name: Deploy
        run: |
          # Enviar arquivos
          scp -o StrictHostKeyChecking=no -i ~/.ssh/key -r dist package.json package-lock.json ecosystem.config.js "$SSH_USER@$SSH_HOST:$APP_DIR/"
          
          # Executar no EC2
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/key "$SSH_USER@$SSH_HOST" "
            cd $APP_DIR
            
            # Instalar dependÃªncias
            npm ci --only=production
            
            # Criar diretÃ³rio de logs com permissÃ£o
            mkdir -p ~/.pm2/logs 2>/dev/null || true
            
            # Parar e iniciar PM2
            pm2 delete app 2>/dev/null || true
            pm2 start ecosystem.config.js
            
            # Salvar configuraÃ§Ã£o
            pm2 save 2>/dev/null || true
            
            echo 'âœ… Deploy concluÃ­do!'
            echo 'ðŸ“Š Status PM2:'
            pm2 list | grep app
          "