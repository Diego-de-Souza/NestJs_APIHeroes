name: Deploy to EC2

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

env:
  AWS_REGION: us-east-1
  SSH_HOST: ${{ secrets.EC2_HOST }}
  SSH_USER: ec2-user
  APP_DIR: /opt/app
  SSH_PORT: 22

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: |
          echo "üî® Buildando aplica√ß√£o NestJS..."
          
          # Remover build anterior
          rm -rf dist
          
          # Executar build
          npm run build
          
          echo "üìÅ Verificando estrutura do dist gerado..."
          
          # Verificar se main.js est√° em dist/src/ (seu caso)
          if [ -f "dist/src/main.js" ]; then
            echo "üîÑ Estrutura incorreta detectada: main.js est√° em dist/src/"
            echo "üì¶ Corrigindo estrutura..."
            
            # Mover todo o conte√∫do de dist/src para dist
            cp -r dist/src/* dist/ 2>/dev/null
            
            # Remover pasta src se estiver vazia
            if [ -d "dist/src" ]; then
              rmdir dist/src 2>/dev/null || true
            fi
            
            echo "‚úÖ Estrutura corrigida: dist/main.js criado"
          fi
          
          # Verificar se main.js existe na raiz do dist
          if [ ! -f "dist/main.js" ]; then
            echo "üîç Procurando main.js em subdiret√≥rios..."
            MAIN_JS_PATH=$(find dist -name "main.js" -type f | head -1)
            
            if [ -n "$MAIN_JS_PATH" ]; then
              echo "üìÑ Main.js encontrado em: $MAIN_JS_PATH"
              echo "üîÑ Copiando para dist/main.js..."
              
              # Criar dist/main.js a partir do arquivo encontrado
              cp "$MAIN_JS_PATH" "dist/main.js"
              echo "‚úÖ dist/main.js criado"
            else
              echo "‚ùå ERRO CR√çTICO: main.js n√£o encontrado em lugar nenhum!"
              echo "üìÅ Listando conte√∫do de dist:"
              find dist -type f -name "*.js" | head -20
              exit 1
            fi
          fi
          
          # Verifica√ß√£o final
          echo "‚úÖ Build conclu√≠do com sucesso!"
          echo "üìÅ Estrutura final do dist:"
          ls -la dist/
          echo "üìÑ Main.js na raiz: $(ls -la dist/main.js 2>/dev/null || echo 'N√ÉO ENCONTRADO')"
        env:
          NODE_ENV: production

      - name: Configure API to listen on all interfaces
        run: |
          echo "üîß Configurando API para escutar em 0.0.0.0..."
          
          # Verificar se main.ts existe
          if [ ! -f "src/main.ts" ]; then
            echo "‚ö†Ô∏è src/main.ts n√£o encontrado, procurando..."
            MAIN_TS=$(find . -name "main.ts" -type f | grep -v node_modules | head -1)
            if [ -n "$MAIN_TS" ]; then
              echo "üìÑ Encontrado em: $MAIN_TS"
              # Usar o arquivo encontrado
              MAIN_TS_FILE="$MAIN_TS"
            else
              echo "‚ùå main.ts n√£o encontrado em lugar nenhum!"
              exit 1
            fi
          else
            MAIN_TS_FILE="src/main.ts"
          fi
          
          # Backup do arquivo original
          cp "$MAIN_TS_FILE" "${MAIN_TS_FILE}.backup"
          
          # Modificar para escutar em 0.0.0.0
          # Primeiro, remove qualquer '0.0.0.0' existente
          sed -i "s/await app\.listen(port, '0\.0\.0\.0')/await app.listen(port)/g" "$MAIN_TS_FILE"
          # Agora adiciona '0.0.0.0'
          sed -i "s/await app\.listen(port)/await app.listen(port, '0.0.0.0')/g" "$MAIN_TS_FILE"
          
          echo "‚úÖ main.ts modificado"
          echo "üìÑ Verifica√ß√£o da modifica√ß√£o:"
          grep -n "listen" "$MAIN_TS_FILE"

      - name: Create PM2 ecosystem file
        run: |
          echo "üìÑ Criando ecosystem.config.js..."
          cat > ecosystem.config.js << 'EOF'
          module.exports = {
            apps: [{
              name: 'app',
              script: './dist/main.js',
              cwd: '.',
              instances: 1,
              autorestart: true,
              watch: false,
              max_memory_restart: '500M',
              env: {
                NODE_ENV: 'production',
                PORT: 3000
              },
              env_production: {
                NODE_ENV: 'production',
                PORT: 3000
              },
              error_file: '/var/log/app-error.log',
              out_file: '/var/log/app-out.log',
              log_file: '/var/log/app-combined.log',
              time: true,
              merge_logs: true,
              log_date_format: 'YYYY-MM-DD HH:mm:ss'
            }]
          }
          EOF
          
          echo "‚úÖ ecosystem.config.js criado"
          echo "üìÑ Conte√∫do:"
          cat ecosystem.config.js

      - name: Prepare deployment package
        run: |
          echo "üì¶ Preparando pacote de deploy..."
          
          # Limpar pacotes anteriores
          rm -rf deploy-package
          mkdir -p deploy-package
          
          # 1. Copiar dist (com estrutura correta)
          echo "üìÅ Copiando dist..."
          cp -r dist deploy-package/
          
          # 2. Copiar package files
          echo "üìÑ Copiando package.json e package-lock.json..."
          cp package.json deploy-package/
          cp package-lock.json deploy-package/
          
          # 3. Copiar ecosystem.config.js
          echo "üìÑ Copiando ecosystem.config.js..."
          cp ecosystem.config.js deploy-package/
          
          # 4. Copiar outros arquivos necess√°rios
          echo "üìÑ Copiando arquivos adicionais..."
          
          # .env.example se existir
          if [ -f ".env.example" ]; then
            cp .env.example deploy-package/
            echo "  - .env.example"
          fi
          
          # nest-cli.json se existir
          if [ -f "nest-cli.json" ]; then
            cp nest-cli.json deploy-package/
            echo "  - nest-cli.json"
          fi
          
          # tsconfig.json se existir
          if [ -f "tsconfig.json" ]; then
            cp tsconfig.json deploy-package/
            echo "  - tsconfig.json"
          fi
          
          # tsconfig.build.json se existir
          if [ -f "tsconfig.build.json" ]; then
            cp tsconfig.build.json deploy-package/
            echo "  - tsconfig.build.json"
          fi
          
          echo ""
          echo "üìÅ Estrutura final do deploy-package:"
          ls -la deploy-package/
          echo ""
          echo "üìÅ Conte√∫do de dist dentro do pacote:"
          ls -la deploy-package/dist/

      - name: Configure SSH key
        run: |
          echo "üîë Configurando chave SSH..."
          
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          
          # Escrever a chave SSH do secret
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          
          # Corrigir formata√ß√£o - converter \n para quebras de linha reais
          sed -i 's/\\n/\n/g' ~/.ssh/deploy_key
          
          # Remover CRLF do Windows se houver
          sed -i 's/\r$//' ~/.ssh/deploy_key
          
          # Garantir que come√ßa com -----BEGIN
          if ! head -1 ~/.ssh/deploy_key | grep -q "BEGIN"; then
            echo "-----BEGIN RSA PRIVATE KEY-----" > ~/.ssh/deploy_key.tmp
            cat ~/.ssh/deploy_key >> ~/.ssh/deploy_key.tmp
            mv ~/.ssh/deploy_key.tmp ~/.ssh/deploy_key
            echo "‚úì Adicionado BEGIN header"
          fi
          
          # Garantir que termina com -----END
          if ! tail -1 ~/.ssh/deploy_key | grep -q "END"; then
            echo "" >> ~/.ssh/deploy_key
            echo "-----END RSA PRIVATE KEY-----" >> ~/.ssh/deploy_key
            echo "‚úì Adicionado END footer"
          fi
          
          # Adicionar newline final
          echo "" >> ~/.ssh/deploy_key
          
          # Ajustar permiss√µes
          chmod 600 ~/.ssh/deploy_key
          
          echo "‚úÖ Chave SSH configurada"
          echo "üìè Tamanho: $(wc -l < ~/.ssh/deploy_key) linhas"

      - name: Test SSH connection
        run: |
          echo "üîå Testando conex√£o SSH com EC2..."
          
          # Testar se a porta SSH est√° acess√≠vel
          echo "üåê Testando porta $SSH_PORT..."
          if timeout 3 nc -z -w 2 "$SSH_HOST" "$SSH_PORT"; then
            echo "‚úÖ Porta $SSH_PORT est√° acess√≠vel"
          else
            echo "‚ùå N√£o foi poss√≠vel acessar a porta $SSH_PORT em $SSH_HOST"
            echo "‚ö†Ô∏è Verifique:"
            echo "  1. O endere√ßo do EC2 est√° correto?"
            echo "  2. O Security Group permite SSH (porta 22)?"
            exit 1
          fi
          
          # Testar conex√£o SSH
          echo "üîó Testando autentica√ß√£o SSH..."
          
          set +e  # N√£o sair no primeiro erro
          SSH_OUTPUT=$(timeout 10 ssh \
            -o StrictHostKeyChecking=no \
            -o ConnectTimeout=8 \
            -o BatchMode=yes \
            -o LogLevel=ERROR \
            -i ~/.ssh/deploy_key \
            "$SSH_USER@$SSH_HOST" \
            "echo '‚úÖ SSH conectado com sucesso!'; echo 'Usu√°rio:' \$(whoami); echo 'Hostname:' \$(hostname); echo 'Node.js:' \$(node --version 2>/dev/null || echo 'N√£o instalado'); exit 0" 2>&1)
          
          SSH_EXIT=$?
          set -e
          
          if [ $SSH_EXIT -eq 0 ]; then
            echo "$SSH_OUTPUT"
            echo "üéâ Conex√£o SSH funcionando perfeitamente!"
          else
            echo "‚ùå Falha na conex√£o SSH"
            echo "üìÑ Sa√≠da do SSH:"
            echo "$SSH_OUTPUT"
            echo ""
            echo "üîç Tentando debug detalhado..."
            timeout 5 ssh -vvv \
              -o ConnectTimeout=3 \
              -i ~/.ssh/deploy_key \
              "$SSH_USER@$SSH_HOST" \
              "exit" 2>&1 | tail -30
            exit 1
          fi

      - name: Deploy to EC2
        run: |
          echo "üöÄ INICIANDO DEPLOY PARA EC2"
          echo "========================================"
          
          # 1. Criar e configurar diret√≥rio da aplica√ß√£o no EC2
          echo ""
          echo "üìÅ PREPARANDO DIRET√ìRIO NO EC2..."
          ssh -o StrictHostKeyChecking=no \
              -o ConnectTimeout=10 \
              -i ~/.ssh/deploy_key \
              "$SSH_USER@$SSH_HOST" \
              "sudo mkdir -p $APP_DIR && \
               sudo chown -R $SSH_USER:$SSH_USER $APP_DIR && \
               echo '‚úÖ Diret√≥rio $APP_DIR criado e configurado'"
          
          # 2. Verificar conte√∫do local do pacote de deploy
          echo ""
          echo "üì¶ VERIFICANDO PACOTE LOCAL..."
          echo "Arquivos no deploy-package:"
          ls -la deploy-package/
          echo ""
          echo "Arquivos em deploy-package/dist:"
          ls -la deploy-package/dist/ 2>/dev/null || echo "‚ö†Ô∏è dist n√£o encontrado localmente!"
          
          # 3. Enviar arquivos para o EC2
          echo ""
          echo "üì§ ENVIANDO ARQUIVOS PARA EC2..."
          rsync -avz \
            --progress \
            --delete \
            -e "ssh -o StrictHostKeyChecking=no -i ~/.ssh/deploy_key" \
            deploy-package/ \
            "$SSH_USER@$SSH_HOST:$APP_DIR/"
          
          echo "‚úÖ Arquivos enviados com sucesso"
          
          # 4. VERIFICAR se os arquivos chegaram corretamente no EC2
          echo ""
          echo "üîç VERIFICANDO ARQUIVOS NO EC2..."
          ssh -o StrictHostKeyChecking=no \
              -i ~/.ssh/deploy_key \
              "$SSH_USER@$SSH_HOST" \
              "echo 'üìÅ ESTRUTURA EM $APP_DIR:'; \
               ls -la $APP_DIR/; \
               echo ''; \
               echo 'üìÅ CONTE√öDO DO DIST:'; \
               if [ -d '$APP_DIR/dist' ]; then \
                 ls -la $APP_DIR/dist/; \
               else \
                 echo '‚ùå ERRO: Pasta dist n√£o encontrada!'; \
                 exit 1; \
               fi; \
               echo ''; \
               echo 'üìÑ VERIFICANDO MAIN.JS:'; \
               if [ -f '$APP_DIR/dist/main.js' ]; then \
                 echo '‚úÖ dist/main.js ENCONTRADO!'; \
                 echo 'üìè Tamanho:' \$(wc -l < '$APP_DIR/dist/main.js') 'linhas'; \
                 echo 'üìÑ Primeiras 5 linhas:'; \
                 head -5 '$APP_DIR/dist/main.js'; \
               else \
                 echo '‚ùå ERRO CR√çTICO: dist/main.js N√ÉO ENCONTRADO!'; \
                 echo 'üîç Procurando main.js em subdiret√≥rios:'; \
                 find $APP_DIR -name 'main.js' -type f; \
                 exit 1; \
               fi"
          
          # 5. INSTALAR DEPEND√äNCIAS E CONFIGURAR APLICA√á√ÉO
          echo ""
          echo "‚öôÔ∏è CONFIGURANDO APLICA√á√ÉO NO EC2..."
          ssh -o StrictHostKeyChecking=no \
              -i ~/.ssh/deploy_key \
              "$SSH_USER@$SSH_HOST" \
              "set -e  # Sai no primeiro erro
               cd $APP_DIR
               
               echo 'üìã AMBIENTE:'
               echo '- Node.js:' \$(node --version)
               echo '- NPM:' \$(npm --version)
               echo '- Diret√≥rio:' \$(pwd)
               
               echo ''
               echo 'üì¶ INSTALANDO DEPEND√äNCIAS DE PRODU√á√ÉO...'
               npm ci --only=production --silent
               echo '‚úÖ Depend√™ncias instaladas'
               
               echo ''
               echo 'üîç VERIFICANDO DEPEND√äNCIAS INSTALADAS:'
               npm list --depth=0 2>/dev/null | grep -E \"^(‚îú‚îÄ‚îÄ|‚îî‚îÄ‚îÄ|‚îú‚îÄ‚î¨|‚îî‚îÄ‚î¨)\" | head -15
               
               echo ''
               echo 'üöÄ CONFIGURANDO PM2...'
               
               # Parar inst√¢ncia existente se houver
               pm2 delete app 2>/dev/null || echo '‚ÑπÔ∏è Nenhuma inst√¢ncia anterior encontrada'
               
               # Iniciar aplica√ß√£o usando ecosystem.config.js
               if [ -f 'ecosystem.config.js' ]; then
                 echo 'üìÑ Iniciando com ecosystem.config.js...'
                 pm2 start ecosystem.config.js --env production
               else
                 echo 'üìÑ Iniciando diretamente...'
                 pm2 start dist/main.js \
                   --name 'app' \
                   --time \
                   --log /var/log/app.log \
                   --error /var/log/app-error.log \
                   --output /var/log/app-out.log
               fi
               
               # Salvar configura√ß√£o do PM2
               pm2 save
               
               # Configurar inicializa√ß√£o autom√°tica (se ainda n√£o configurado)
               pm2 startup 2>/dev/null || echo '‚ÑπÔ∏è Startup j√° configurado'
               
               echo ''
               echo '‚úÖ APLICA√á√ÉO INICIADA!'
               
               # Aguardar alguns segundos para a aplica√ß√£o iniciar
               sleep 3
               
               echo ''
               echo 'üìä STATUS DA APLICA√á√ÉO:'
               pm2 status app
               
               echo ''
               echo 'üìÑ √öLTIMOS LOGS:'
               pm2 logs app --lines 8 --nostream
               
               echo ''
               echo 'üåê TESTANDO API LOCALMENTE...'
               # Tentar v√°rios endpoints comuns
               for endpoint in '/health' '/api/health' '/status' '/'; do
                 if curl -s -f -o /dev/null -w \"%{http_code}\" http://localhost:3000\$endpoint --connect-timeout 5 | grep -q \"^2\|^3\"; then
                   echo \"‚úÖ API respondendo em http://localhost:3000\$endpoint\"
                   break
                 fi
               done || echo '‚ö†Ô∏è API n√£o respondeu ainda (pode estar iniciando)'
               
               echo ''
               echo 'üíæ USO DE DISCO:'
               du -sh ."
          
          # 6. VERIFICA√á√ÉO FINAL
          echo ""
          echo "üîç VERIFICA√á√ÉO FINAL DO DEPLOY..."
          ssh -o StrictHostKeyChecking=no \
              -i ~/.ssh/deploy_key \
              "$SSH_USER@$SSH_HOST" \
              "cd $APP_DIR
               
               echo 'üìä PM2 STATUS COMPLETO:'
               pm2 list
               
               echo ''
               echo 'üîç VERIFICANDO SE APLICA√á√ÉO EST√Å RODANDO:'
               if pm2 list | grep -q 'app.*online'; then
                 echo '‚úÖ APLICA√á√ÉO EST√Å ONLINE!'
                 echo '‚è±Ô∏è  Uptime:'
                 pm2 show app | grep -E '(status|uptime|memory|cpu)'
               else
                 echo '‚ùå APLICA√á√ÉO N√ÉO EST√Å ONLINE!'
                 echo 'üìÑ LOGS DE ERRO:'
                 tail -20 /var/log/app-error.log 2>/dev/null || echo 'Arquivo de log n√£o encontrado'
                 exit 1
               fi"
          
          echo ""
          echo "========================================"
          echo "üéâ DEPLOY CONCLU√çDO COM SUCESSO!"
          echo "üì° Endpoint p√∫blico: http://${{ secrets.EC2_HOST }}:3000"
          echo "========================================"

      - name: Cleanup
        if: always()
        run: |
          echo "üßπ Limpando arquivos tempor√°rios..."
          rm -f ~/.ssh/deploy_key 2>/dev/null || true
          rm -rf deploy-package 2>/dev/null || true
          
          # Restaurar main.ts original se backup existir
          if [ -f "src/main.ts.backup" ]; then
            mv src/main.ts.backup src/main.ts
            echo "‚úÖ main.ts restaurado"
          fi
          
          echo "‚úÖ Limpeza conclu√≠da"