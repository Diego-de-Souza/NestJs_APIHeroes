# Triggers do workflow: push na main/master e manual
on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

env:
  AWS_REGION: us-east-1
  BACKEND_HOST: ${{ secrets.DB_HOST }}  # Corrigido: DB_HOST, não BD_HOST
  SSH_HOST: ${{ secrets.EC2_HOST }}  # Use EC2_HOST diretamente
  SSH_USER: ec2-user
  APP_DIR: /opt/app
  SSH_PORT: 22  # Defina fixo ou use variável
  SSH_TIMEOUT: 30

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      # ...checkout, build, etc...

      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key

          # IMPORTANTE: O conteúdo da chave deve ter \n no final
          # Se a chave não terminar com newline, adicione:
          echo "" >> ~/.ssh/deploy_key

          cat > ~/.ssh/config << EOF
          Host ${{ env.SSH_HOST }}
            HostName ${{ env.SSH_HOST }}
            Port ${{ env.SSH_PORT }}
            User ${{ env.SSH_USER }}
            IdentityFile ~/.ssh/deploy_key
            StrictHostKeyChecking no
            UserKnownHostsFile /dev/null
            ConnectTimeout ${{ env.SSH_TIMEOUT }}
            ServerAliveInterval 60
            ServerAliveCountMax 3
          EOF
          chmod 600 ~/.ssh/config

          echo "Testing connection to ${{ env.SSH_HOST }}:${{ env.SSH_PORT }}..."
          
          # Teste mais robusto
          if nc -z -w 5 "${{ env.SSH_HOST }}" "${{ env.SSH_PORT }}" 2>/dev/null; then
            echo "✅ Port ${{ env.SSH_PORT }} is open and reachable"
          else
            echo "❌ Port ${{ env.SSH_PORT }} is not reachable"
            exit 1
          fi

          # Adicionar fingerprint
          ssh-keyscan -p "${{ env.SSH_PORT }}" -H "${{ env.SSH_HOST }}" 2>/dev/null >> ~/.ssh/known_hosts
          chmod 644 ~/.ssh/known_hosts

      - name: Test SSH connection
        run: |
          echo "Testing SSH connection to ${{ env.SSH_USER }}@${{ env.SSH_HOST }}:${{ env.SSH_PORT }}..."
          
          # Teste direto primeiro
          ssh -v -i ~/.ssh/deploy_key \
            -o StrictHostKeyChecking=no \
            -o UserKnownHostsFile=/dev/null \
            -o ConnectTimeout=10 \
            -p "${{ env.SSH_PORT }}" \
            "${{ env.SSH_USER }}@${{ env.SSH_HOST }}" \
            "echo '✅ SSH connection successful'" || {
              echo "❌ SSH connection failed"
              echo "Debug info:"
              echo "SSH_HOST: ${{ env.SSH_HOST }}"
              echo "SSH_PORT: ${{ env.SSH_PORT }}"
              echo "SSH_USER: ${{ env.SSH_USER }}"
              echo "Checking key file..."
              head -5 ~/.ssh/deploy_key
              exit 1
            }
          
          echo "✅ SSH connection successful!"