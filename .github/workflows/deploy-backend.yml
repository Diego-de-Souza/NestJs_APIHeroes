name: Deploy to EC2

on:
  push:
    branches: [main, master]
  workflow_dispatch:

env:
  SSH_HOST: ${{ secrets.EC2_HOST }}
  SSH_USER: ec2-user
  APP_DIR: /opt/app
  
  # Vari√°veis de ambiente da aplica√ß√£o (usar secrets para dados sens√≠veis)
  NODE_ENV: production
  PORT: 3000

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: Install dependencies
        run: |
          npm ci
          npm install -g @nestjs/cli
          
      - name: Build application
        run: npm run build
        env:
          NODE_ENV: production
          
      - name: Fix dist structure
        run: |
          # Corrigir se main.js est√° em dist/src/
          if [ -f "dist/src/main.js" ]; then
            mv dist/src/* dist/ 2>/dev/null || true
            rmdir dist/src 2>/dev/null || true
          fi
          
      - name: Configure API to listen on all interfaces
        run: |
          if [ -f "src/main.ts" ]; then
            sed -i "s/await app\.listen(port)/await app.listen(port, '0.0.0.0')/g" src/main.ts
          fi
          
      - name: Create .env file for EC2
        run: |
          # Criar arquivo .env com todas as vari√°veis necess√°rias
          cat > .env.production << 'EOF'
          # Application
          NODE_ENV=production
          PORT=3000
          
          # Database (use secrets do GitHub)
          DB_HOST=${{ secrets.DB_HOST }}
          DB_PORT=${{ secrets.DB_PORT }}
          DB_USERNAME=${{ secrets.DB_USERNAME }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          DB_DATABASE=${{ secrets.DB_DATABASE }}
          
          # JWT / Authentication
          JWT_SECRET=${{ secrets.JWT_SECRET }}
          JWT_EXPIRES_IN=${{ secrets.JWT_EXPIRES_IN || '7d' }}
          
          # AWS (se usar)
          AWS_REGION=${{ secrets.AWS_REGION || 'us-east-1' }}
          AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}
          
          # Other environment variables
          APP_NAME=${{ secrets.APP_NAME || 'My NestJS App' }}
          LOG_LEVEL=${{ secrets.LOG_LEVEL || 'info' }}
          CORS_ORIGIN=${{ secrets.CORS_ORIGIN || '*' }}
          
          # Adicione outras vari√°veis conforme necess√°rio
          # API_KEY=${{ secrets.API_KEY }}
          # REDIS_URL=${{ secrets.REDIS_URL }}
          EOF
          
          # Verificar se o arquivo foi criado (sem expor os valores)
          echo "‚úÖ .env.production criado"
          echo "üìÑ Estrutura do arquivo (valores ocultos):"
          cat .env.production | sed 's/=.*/=***HIDDEN***/'
          
      - name: Create PM2 ecosystem config
        run: |
          # Criar ecosystem.config.js que carrega o .env
          cat > ecosystem.config.js << 'EOF'
          const dotenv = require('dotenv');
          const path = require('path');
          
          // Carregar vari√°veis de ambiente
          dotenv.config({ path: path.resolve(__dirname, '.env') });
          
          module.exports = {
            apps: [{
              name: 'app',
              script: './dist/main.js',
              instances: 1,
              autorestart: true,
              watch: false,
              max_memory_restart: '500M',
              env: {
                NODE_ENV: 'production',
                PORT: process.env.PORT || 3000,
                // Outras vari√°veis ser√£o herdadas do .env
              },
              env_production: {
                NODE_ENV: 'production'
              }
            }]
          };
          EOF
          
      - name: Prepare deployment package
        run: |
          # Criar diret√≥rio de deploy
          rm -rf _deploy
          mkdir -p _deploy
          
          # Copiar arquivos necess√°rios
          cp -r dist _deploy/
          cp package.json _deploy/
          cp package-lock.json _deploy/
          cp ecosystem.config.js _deploy/
          
          # Copiar .env.production como .env no deploy
          cp .env.production _deploy/.env
          
          # Copiar outros arquivos opcionais
          [ -f "nest-cli.json" ] && cp nest-cli.json _deploy/
          [ -f "tsconfig.json" ] && cp tsconfig.json _deploy/
          
          echo "üì¶ Pacote de deploy preparado:"
          ls -la _deploy/
          
      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          
          # Corrigir formata√ß√£o da chave
          sed -i 's/\\n/\n/g' ~/.ssh/deploy_key
          sed -i 's/\r$//' ~/.ssh/deploy_key
          
          # Verificar e corrigir formato PEM
          if ! grep -q "BEGIN" ~/.ssh/deploy_key; then
            echo "-----BEGIN RSA PRIVATE KEY-----" > ~/.ssh/deploy_key.tmp
            cat ~/.ssh/deploy_key >> ~/.ssh/deploy_key.tmp
            mv ~/.ssh/deploy_key.tmp ~/.ssh/deploy_key
          fi
          
          if ! grep -q "END" ~/.ssh/deploy_key; then
            echo "-----END RSA PRIVATE KEY-----" >> ~/.ssh/deploy_key
          fi
          
          chmod 600 ~/.ssh/deploy_key
          echo "‚úÖ Chave SSH configurada"
          
      - name: Test SSH connection
        run: |
          ssh -o StrictHostKeyChecking=no \
              -o ConnectTimeout=5 \
              -i ~/.ssh/deploy_key \
              "$SSH_USER@$SSH_HOST" \
              "echo '‚úÖ SSH connection successful'"
              
      - name: Deploy to EC2
        run: |
          echo "üöÄ Iniciando deploy para EC2..."
          
          # 1. Criar diret√≥rio no EC2
          ssh -o StrictHostKeyChecking=no \
              -i ~/.ssh/deploy_key \
              "$SSH_USER@$SSH_HOST" \
              "sudo mkdir -p $APP_DIR && sudo chown -R $SSH_USER:$SSH_USER $APP_DIR"
          
          # 2. Enviar arquivos
          echo "üì§ Enviando arquivos para EC2..."
          rsync -avz \
            --progress \
            -e "ssh -o StrictHostKeyChecking=no -i ~/.ssh/deploy_key" \
            _deploy/ \
            "$SSH_USER@$SSH_HOST:$APP_DIR/"
          
          # 3. Configurar aplica√ß√£o no EC2
          echo "‚öôÔ∏è Configurando aplica√ß√£o no EC2..."
          ssh -o StrictHostKeyChecking=no \
              -i ~/.ssh/deploy_key \
              "$SSH_USER@$SSH_HOST" "
            set -e
            cd $APP_DIR
            
            echo 'üìã Verificando arquivos recebidos...'
            ls -la
            echo ''
            echo 'üîí Verificando .env (valores ocultos):'
            cat .env | sed 's/=.*/=***HIDDEN***/' || echo '‚ö†Ô∏è .env n√£o encontrado'
            
            echo ''
            echo 'üì¶ Instalando depend√™ncias de produ√ß√£o...'
            npm ci --only=production --silent
            echo '‚úÖ Depend√™ncias instaladas'
            
            echo ''
            echo 'üîß Instalando dotenv para PM2...'
            npm install dotenv --save --silent || echo '‚ÑπÔ∏è dotenv j√° instalado'
            
            echo ''
            echo 'üöÄ Iniciando aplica√ß√£o com PM2...'
            
            # Parar inst√¢ncia anterior
            pm2 delete app 2>/dev/null || echo '‚ÑπÔ∏è Nenhuma inst√¢ncia anterior'
            
            # Iniciar com ecosystem.config
            pm2 start ecosystem.config.js --env production
            
            # Salvar configura√ß√£o do PM2
            pm2 save 2>/dev/null || true
            
            # Configurar startup (se ainda n√£o configurado)
            pm2 startup 2>/dev/null || echo '‚ÑπÔ∏è Startup j√° configurado'
            
            echo ''
            echo '‚úÖ Aplica√ß√£o iniciada!'
            echo ''
            echo 'üìä Status PM2:'
            pm2 list
            
            echo ''
            echo 'üåê Testando API...'
            sleep 2
            curl -s -o /dev/null -w 'HTTP Status: %{http_code}\n' http://localhost:3000 || \
            curl -s -o /dev/null -w 'HTTP Status: %{http_code}\n' http://localhost:3000/api/health || \
            echo '‚ö†Ô∏è API ainda n√£o respondendo (pode estar iniciando)'
          "
          
          echo ""
          echo "üéâ DEPLOY CONCLU√çDO COM SUCESSO!"
          echo "üì° Aplica√ß√£o dispon√≠vel em: http://${{ secrets.EC2_HOST }}:3000"
          
      - name: Cleanup
        if: always()
        run: |
          rm -rf _deploy
          rm -f ~/.ssh/deploy_key
          rm -f .env.production
          echo "‚úÖ Limpeza conclu√≠da"