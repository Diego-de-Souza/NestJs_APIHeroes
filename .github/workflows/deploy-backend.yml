name: Deploy to EC2

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

env:
  AWS_REGION: us-east-1
  SSH_HOST: ${{ secrets.EC2_HOST }}
  SSH_USER: ec2-user
  APP_DIR: /opt/app
  SSH_PORT: 22

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build
        env:
          NODE_ENV: production

      - name: Prepare deployment package
        run: |
          # Criar diretÃ³rio temporÃ¡rio para deploy
          mkdir -p deploy-package
          
          # Copiar os arquivos necessÃ¡rios
          cp -r dist deploy-package/
          cp package.json deploy-package/
          cp package-lock.json deploy-package/
          
          # Opcional: copiar outros arquivos necessÃ¡rios
          if [ -f ".env.production" ]; then
            cp .env.production deploy-package/
          fi
          if [ -f "ecosystem.config.js" ]; then
            cp ecosystem.config.js deploy-package/
          fi
          
          echo "ðŸ“¦ Pacote de deploy preparado:"
          ls -la deploy-package/

      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          
          # Escrever a chave SSH
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          
          # Corrigir formataÃ§Ã£o
          sed -i 's/\\n/\n/g' ~/.ssh/deploy_key  # Converter \n para quebras de linha reais
          sed -i 's/\r$//' ~/.ssh/deploy_key     # Remover CRLF do Windows
          
          # Garantir que comeÃ§a e termina corretamente
          if ! head -1 ~/.ssh/deploy_key | grep -q "BEGIN"; then
            echo "-----BEGIN RSA PRIVATE KEY-----" > ~/.ssh/deploy_key.tmp
            cat ~/.ssh/deploy_key >> ~/.ssh/deploy_key.tmp
            mv ~/.ssh/deploy_key.tmp ~/.ssh/deploy_key
          fi
          
          if ! tail -1 ~/.ssh/deploy_key | grep -q "END"; then
            echo "-----END RSA PRIVATE KEY-----" >> ~/.ssh/deploy_key
          fi
          
          # Adicionar newline final
          echo "" >> ~/.ssh/deploy_key
          
          chmod 600 ~/.ssh/deploy_key
          
          # Verificar a chave
          echo "=== Verificando chave SSH ==="
          echo "Linhas: $(wc -l ~/.ssh/deploy_key)"
          echo "Primeira linha: $(head -1 ~/.ssh/deploy_key)"
          echo "Ãšltima linha: $(tail -1 ~/.ssh/deploy_key)"
          
          # Testar se a chave Ã© vÃ¡lida
          if ssh-keygen -y -f ~/.ssh/deploy_key > /dev/null 2>&1; then
            echo "âœ… Chave SSH vÃ¡lida"
          else
            echo "âŒ Chave SSH invÃ¡lida"
            exit 1
          fi

      - name: Test SSH connection
        run: |
          echo "=== Testando conexÃ£o SSH ==="
          echo "Conectando em $SSH_USER@$SSH_HOST:$SSH_PORT"
          
          # Teste simples de porta
          timeout 5 nc -zv "$SSH_HOST" "$SSH_PORT" && echo "âœ… Porta 22 acessÃ­vel"
          
          # Teste SSH
          set +e  # NÃ£o sair no primeiro erro
          ssh_output=$(timeout 15 ssh \
            -o StrictHostKeyChecking=no \
            -o UserKnownHostsFile=/dev/null \
            -o ConnectTimeout=10 \
            -o LogLevel=ERROR \
            -i ~/.ssh/deploy_key \
            "$SSH_USER@$SSH_HOST" \
            "echo 'âœ… ConexÃ£o SSH bem-sucedida'; whoami; hostname" 2>&1)
          
          ssh_exit=$?
          
          if [ $ssh_exit -eq 0 ]; then
            echo "$ssh_output"
            echo "âœ… SSH funcionando perfeitamente!"
          else
            echo "âŒ Falha na conexÃ£o SSH"
            echo "SaÃ­da do SSH:"
            echo "$ssh_output"
            
            # Tentar com verbose para debug
            echo "=== DEBUG com verbose ==="
            timeout 10 ssh -vvv \
              -o ConnectTimeout=5 \
              -i ~/.ssh/deploy_key \
              "$SSH_USER@$SSH_HOST" \
              "echo test" 2>&1 | tail -50
            exit 1
          fi

      - name: Configure API to listen on all interfaces
        run: |
          sed -i "s/await app\.listen(port)/await app.listen(port, '0.0.0.0')/" src/main.ts
          
      - name: Deploy to EC2
        run: |
          echo "=== Iniciando deploy ==="
          
          # Criar diretÃ³rio da aplicaÃ§Ã£o
          ssh -o StrictHostKeyChecking=no \
              -i ~/.ssh/deploy_key \
              "$SSH_USER@$SSH_HOST" \
              "sudo mkdir -p $APP_DIR && sudo chown -R $SSH_USER:$SSH_USER $APP_DIR"
          
          # Sincronizar APENAS o pacote de deploy
          echo "ðŸ“¤ Enviando arquivos para o EC2..."
          rsync -avz -e "ssh -o StrictHostKeyChecking=no -i ~/.ssh/deploy_key" \
            --delete \
            deploy-package/ \
            "$SSH_USER@$SSH_HOST:$APP_DIR/"
          
          # Executar deploy no servidor (APENAS instalaÃ§Ã£o de dependÃªncias)
          echo "âš™ï¸ Configurando aplicaÃ§Ã£o no EC2..."
          ssh -o StrictHostKeyChecking=no \
              -i ~/.ssh/deploy_key \
              "$SSH_USER@$SSH_HOST" \
              "cd $APP_DIR && \
               echo 'ðŸ“‹ VersÃµes:' && \
               node --version && npm --version && \
               echo 'ðŸ“¦ Instalando dependÃªncias de produÃ§Ã£o...' && \
               npm ci --only=production --silent && \
               echo 'ðŸš€ Iniciando/Reiniciando aplicaÃ§Ã£o...' && \
               pm2 delete app 2>/dev/null || true && \
               pm2 start dist/main.js --name 'app' && \
               pm2 save && \
               echo 'âœ… Deploy concluÃ­do!' && \
               pm2 status app"
          
          echo "ðŸŽ‰ Deploy finalizado com sucesso!"