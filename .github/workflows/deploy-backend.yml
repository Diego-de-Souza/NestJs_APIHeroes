name: Deploy to EC2

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

env:
  AWS_REGION: us-east-1
  SSH_HOST: ${{ secrets.EC2_HOST }}
  SSH_USER: ec2-user
  APP_DIR: /opt/app
  SSH_PORT: 22

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: |
          echo "üî® Buildando aplica√ß√£o NestJS..."
          # Limpar builds anteriores
          rm -rf dist
          
          # Build da aplica√ß√£o
          npm run build
          
          # Verificar se o main.js foi gerado
          echo "üìÅ Verificando resultado do build..."
          if [ ! -f "dist/main.js" ]; then
            echo "‚ùå ERRO CR√çTICO: dist/main.js n√£o foi gerado!"
            echo "üìÑ Listando conte√∫do de dist/:"
            ls -la dist/ 2>/dev/null || echo "dist/ n√£o existe"
            echo "üîç Verificando tsconfig.json:"
            cat tsconfig.json
            exit 1
          fi
          
          echo "‚úÖ Build conclu√≠do - main.js encontrado"
          echo "üìÑ Primeiras linhas do main.js:"
          head -5 dist/main.js
        env:
          NODE_ENV: production

      - name: Configure API to listen on all interfaces
        run: |
          echo "üîß Configurando API para escutar em 0.0.0.0..."
          # Backup do arquivo original
          cp src/main.ts src/main.ts.backup
          
          # Modificar o listen para aceitar conex√µes externas
          # Primeiro, remove qualquer '0.0.0.0' existente
          sed -i "s/await app.listen(port, '0.0.0.0')/await app.listen(port)/g" src/main.ts
          # Agora adiciona
          sed -i "s/await app\.listen(port)/await app.listen(port, '0.0.0.0')/" src/main.ts
          
          echo "üìÑ Verificando altera√ß√£o no main.ts:"
          grep -n "listen" src/main.ts

      - name: Prepare deployment package
        run: |
          echo "üì¶ Preparando pacote de deploy..."
          # Limpar pacotes anteriores
          rm -rf deploy-package
          mkdir -p deploy-package
          
          # Copiar build gerado
          echo "üìÅ Copiando dist..."
          cp -r dist deploy-package/
          
          # Copiar package files
          echo "üìÑ Copiando package.json e package-lock.json..."
          cp package.json deploy-package/
          cp package-lock.json deploy-package/
          
          # Copiar arquivos adicionais que podem ser necess√°rios
          echo "üìÑ Copiando arquivos adicionais..."
          [ -f ".env.example" ] && cp .env.example deploy-package/
          [ -f "ecosystem.config.js" ] && cp ecosystem.config.js deploy-package/
          [ -f "nest-cli.json" ] && cp nest-cli.json deploy-package/
          [ -f "tsconfig.build.json" ] && cp tsconfig.build.json deploy-package/
          
          # Verificar conte√∫do
          echo "üìÅ Estrutura do deploy-package:"
          find deploy-package -type f | sort
          echo ""
          echo "üìÑ Tamanho do dist:"
          du -sh deploy-package/dist/

      - name: Configure SSH
        run: |
          echo "üîë Configurando chave SSH..."
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          
          # Escrever a chave SSH
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          
          # Corrigir formata√ß√£o
          sed -i 's/\\n/\n/g' ~/.ssh/deploy_key
          sed -i 's/\r$//' ~/.ssh/deploy_key
          
          # Garantir que come√ßa e termina corretamente
          if ! grep -q "BEGIN RSA PRIVATE KEY" ~/.ssh/deploy_key; then
            echo "-----BEGIN RSA PRIVATE KEY-----" > ~/.ssh/deploy_key.tmp
            cat ~/.ssh/deploy_key >> ~/.ssh/deploy_key.tmp
            mv ~/.ssh/deploy_key.tmp ~/.ssh/deploy_key
          fi
          
          if ! grep -q "END RSA PRIVATE KEY" ~/.ssh/deploy_key; then
            echo "-----END RSA PRIVATE KEY-----" >> ~/.ssh/deploy_key
          fi
          
          # Adicionar newline final
          echo "" >> ~/.ssh/deploy_key
          
          chmod 600 ~/.ssh/deploy_key
          
          # Validar chave
          echo "‚úÖ Chave SSH salva"
          echo "üìè Tamanho: $(wc -l < ~/.ssh/deploy_key) linhas"

      - name: Test SSH connection
        run: |
          echo "üîå Testando conex√£o SSH com EC2..."
          
          # Testar se a porta est√° aberta
          echo "üåê Testando porta $SSH_PORT..."
          if timeout 3 nc -z "$SSH_HOST" "$SSH_PORT"; then
            echo "‚úÖ Porta $SSH_PORT acess√≠vel"
          else
            echo "‚ùå Porta $SSH_PORT n√£o acess√≠vel"
            exit 1
          fi
          
          # Testar conex√£o SSH
          echo "üîó Testando autentica√ß√£o SSH..."
          ssh -o StrictHostKeyChecking=no \
              -o ConnectTimeout=10 \
              -o BatchMode=yes \
              -i ~/.ssh/deploy_key \
              "$SSH_USER@$SSH_HOST" \
              "echo '‚úÖ Conex√£o SSH bem-sucedida'; echo 'Usu√°rio:' \$(whoami); echo 'Hostname:' \$(hostname)"
          
          if [ $? -eq 0 ]; then
            echo "üéâ Conex√£o SSH funcionando perfeitamente!"
          else
            echo "‚ùå Falha na conex√£o SSH"
            echo "üîç Debug com verbose:"
            ssh -vvv -o ConnectTimeout=5 -i ~/.ssh/deploy_key "$SSH_USER@$SSH_HOST" "exit" 2>&1 | tail -20
            exit 1
          fi

      - name: Deploy to EC2
        run: |
          echo "üöÄ INICIANDO DEPLOY PARA EC2"
          echo "========================================"
          
          # 1. Criar diret√≥rio da aplica√ß√£o no EC2
          echo "üìÅ Criando diret√≥rio $APP_DIR no EC2..."
          ssh -o StrictHostKeyChecking=no \
              -o ConnectTimeout=10 \
              -i ~/.ssh/deploy_key \
              "$SSH_USER@$SSH_HOST" \
              "sudo mkdir -p $APP_DIR && \
               sudo chown -R $SSH_USER:$SSH_USER $APP_DIR && \
               echo '‚úÖ Diret√≥rio criado e permiss√µes ajustadas'"
          
          # 2. Verificar o que tem no deploy-package localmente
          echo ""
          echo "üì¶ VERIFICANDO PACOTE LOCAL:"
          echo "Conte√∫do do deploy-package:"
          ls -la deploy-package/
          echo ""
          echo "Conte√∫do do dist local:"
          ls -la deploy-package/dist/ 2>/dev/null || echo "‚ö†Ô∏è dist n√£o encontrado localmente"
          
          # 3. Sincronizar arquivos com EC2
          echo ""
          echo "üì§ ENVIANDO ARQUIVOS PARA EC2..."
          rsync -avz \
            --progress \
            --delete \
            -e "ssh -o StrictHostKeyChecking=no -i ~/.ssh/deploy_key" \
            deploy-package/ \
            "$SSH_USER@$SSH_HOST:$APP_DIR/"
          
          echo "‚úÖ Arquivos enviados para EC2"
          
          # 4. Verificar se os arquivos chegaram no EC2
          echo ""
          echo "üîç VERIFICANDO ARQUIVOS NO EC2:"
          ssh -o StrictHostKeyChecking=no \
              -i ~/.ssh/deploy_key \
              "$SSH_USER@$SSH_HOST" \
              "echo 'üìÅ Estrutura em $APP_DIR:'; \
               ls -la $APP_DIR/; \
               echo ''; \
               echo 'üìÅ Conte√∫do de $APP_DIR/dist:'; \
               ls -la $APP_DIR/dist/ 2>/dev/null || echo '‚ùå dist n√£o encontrado'; \
               echo ''; \
               if [ -f '$APP_DIR/dist/main.js' ]; then \
                 echo '‚úÖ main.js encontrado!'; \
                 echo 'üìÑ Primeiras linhas:'; \
                 head -3 '$APP_DIR/dist/main.js'; \
               else \
                 echo '‚ùå ERRO: main.js n√£o encontrado!'; \
                 echo 'Procurando por arquivos JS:'; \
                 find '$APP_DIR' -name '*.js' -type f | head -10; \
                 exit 1; \
               fi"
          
          # 5. Instalar depend√™ncias e iniciar aplica√ß√£o
          echo ""
          echo "‚öôÔ∏è CONFIGURANDO APLICA√á√ÉO NO EC2..."
          ssh -o StrictHostKeyChecking=no \
              -i ~/.ssh/deploy_key \
              "$SSH_USER@$SSH_HOST" \
              "set -e  # Sai no primeiro erro
               cd $APP_DIR
               
               echo 'üìã Vers√µes do ambiente:'
               node --version
               npm --version
               
               echo ''
               echo 'üì¶ INSTALANDO DEPEND√äNCIAS...'
               # Instalar apenas depend√™ncias de produ√ß√£o
               npm ci --only=production --silent
               echo '‚úÖ Depend√™ncias instaladas'
               
               echo ''
               echo 'üîç VERIFICANDO DEPEND√äNCIAS:'
               npm list --depth=0 2>/dev/null | head -20
               
               echo ''
               echo 'üöÄ INICIANDO APLICA√á√ÉO COM PM2...'
               
               # Parar aplica√ß√£o existente se houver
               pm2 delete app 2>/dev/null || true
               
               # Iniciar nova inst√¢ncia
               pm2 start dist/main.js \
                 --name 'app' \
                 --time \
                 --log /var/log/app.log \
                 --error /var/log/app-error.log \
                 --output /var/log/app-out.log \
                 --restart-delay 3000
               
               # Salvar configura√ß√£o do PM2
               pm2 save
               
               # Configurar inicializa√ß√£o autom√°tica
               pm2 startup 2>/dev/null || true
               
               echo ''
               echo '‚úÖ APLICA√á√ÉO INICIADA!'
               echo ''
               echo 'üìä STATUS DA APLICA√á√ÉO:'
               pm2 status app
               
               echo ''
               echo 'üìÑ √öLTIMOS LOGS:'
               pm2 logs app --lines 5 --nostream
               
               echo ''
               echo 'üåê TESTANDO API LOCALMENTE...'
               sleep 2
               curl -f http://localhost:3000/api/health 2>/dev/null || \
               curl -f http://localhost:3000 2>/dev/null || \
               curl -f http://localhost:3000/health 2>/dev/null || \
                 echo '‚ö†Ô∏è API pode n√£o estar respondendo ainda (verifique logs)'"
          
          # 6. Verificar se a aplica√ß√£o est√° rodando
          echo ""
          echo "üîç VERIFICA√á√ÉO FINAL..."
          ssh -o StrictHostKeyChecking=no \
              -i ~/.ssh/deploy_key \
              "$SSH_USER@$SSH_HOST" \
              "if pm2 list | grep -q 'app'; then \
                 echo '‚úÖ Aplica√ß√£o est√° rodando no PM2'; \
                 echo 'üìä Detalhes:'; \
                 pm2 info app | grep -E '(status|uptime|memory)'; \
               else \
                 echo '‚ùå Aplica√ß√£o N√ÉO est√° rodando!'; \
                 echo 'üìÑ Verificando logs de erro:'; \
                 tail -20 /var/log/app-error.log 2>/dev/null || echo 'Log n√£o encontrado'; \
                 exit 1; \
               fi"
          
          echo ""
          echo "========================================"
          echo "üéâ DEPLOY CONCLU√çDO COM SUCESSO!"
          echo "üì° API dispon√≠vel em: http://$SSH_HOST:3000"
          echo "========================================"

      # Opcional: Limpeza
      - name: Cleanup
        if: always()
        run: |
          echo "üßπ Limpando arquivos tempor√°rios..."
          rm -f ~/.ssh/deploy_key
          rm -rf deploy-package
          echo "‚úÖ Limpeza conclu√≠da"