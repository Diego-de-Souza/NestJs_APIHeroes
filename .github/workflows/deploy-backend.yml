# Triggers do workflow: push na main/master e manual
on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:
env:
  AWS_REGION: us-east-1
  BACKEND_HOST: ${{ secrets.BD_HOST }}
  SSH_HOST: ${{ secrets.EC2_HOST || secrets.BD_HOST }}
  SSH_USER: ec2-user
  APP_DIR: /opt/app
  SSH_PORT: ${{ vars.SSH_PORT || '22' }}
  SSH_TIMEOUT: 30

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      # ...checkout, build, etc...

      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key

          cat > ~/.ssh/config << EOF
          Host ${{ env.BD_HOST }}
            HostName ${{ env.SSH_HOST }}
            Port ${{ env.SSH_PORT }}
            User ${{ env.SSH_USER }}
            IdentityFile ~/.ssh/deploy_key
            StrictHostKeyChecking no
            UserKnownHostsFile /dev/null
            ConnectTimeout ${{ env.SSH_TIMEOUT }}
            ServerAliveInterval 60
            ServerAliveCountMax 3
          EOF
          chmod 600 ~/.ssh/config

          echo "Testing connection to ${{ env.SSH_HOST }}:${{ env.SSH_PORT }}..."
          if timeout 10 bash -c "cat < /dev/null > /dev/tcp/${{ env.SSH_HOST }}/${{ env.SSH_PORT }}" 2>/dev/null; then
            echo "✅ Port ${{ env.SSH_PORT }} is open and reachable"
          else
            echo "❌ Port ${{ env.SSH_PORT }} test failed"
            exit 1
          fi

          if [ -n "${{ env.SSH_HOST }}" ]; then
            ssh-keyscan -p ${{ env.SSH_PORT }} -H "${{ env.SSH_HOST }}" >> ~/.ssh/known_hosts 2>/dev/null || echo "Warning: Could not add host to known_hosts, but continuing..."
            chmod 644 ~/.ssh/known_hosts
          fi

      - name: Test SSH connection
        run: |
          SSH_CONFIG_PATH="$HOME/.ssh/config"
          SSH_CONNECTION_FAILED=false

          if [ -f "$SSH_CONFIG_PATH" ]; then
            ssh -F "$SSH_CONFIG_PATH" ${{ env.BACKEND_HOST }} "echo 'SSH connection successful'" || SSH_CONNECTION_FAILED=true
          else
            ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SSH_HOST }} "echo 'SSH connection successful'" || SSH_CONNECTION_FAILED=true
          fi

          if [ "$SSH_CONNECTION_FAILED" = true ]; then
            echo "❌ ERROR: Cannot connect to ${{ env.SSH_HOST }}:${{ env.SSH_PORT }}"
            exit 1
          fi

          echo "✅ SSH connection successful!"