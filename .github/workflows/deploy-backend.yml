name: Deploy to EC2

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

env:
  AWS_REGION: us-east-1
  SSH_HOST: ${{ secrets.EC2_HOST }}
  SSH_USER: ec2-user
  APP_DIR: /opt/app
  SSH_PORT: 22

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: |
          echo "üî® Buildando aplica√ß√£o NestJS..."
          
          # Remover build anterior
          rm -rf dist
          
          # Executar build
          npm run build
          
          echo "üìÅ Verificando estrutura do dist gerado..."
          
          # Verificar se main.js est√° em dist/src/ (seu caso)
          if [ -f "dist/src/main.js" ]; then
            echo "üîÑ Estrutura incorreta detectada: main.js est√° em dist/src/"
            echo "üì¶ Corrigindo estrutura..."
            
            # Mover todo o conte√∫do de dist/src para dist
            cp -r dist/src/* dist/ 2>/dev/null
            
            # Remover pasta src se estiver vazia
            if [ -d "dist/src" ]; then
              rmdir dist/src 2>/dev/null || true
            fi
            
            echo "‚úÖ Estrutura corrigida: dist/main.js criado"
          fi
          
          # Verificar se main.js existe na raiz do dist
          if [ ! -f "dist/main.js" ]; then
            echo "üîç Procurando main.js em subdiret√≥rios..."
            MAIN_JS_PATH=$(find dist -name "main.js" -type f | head -1)
            
            if [ -n "$MAIN_JS_PATH" ]; then
              echo "üìÑ Main.js encontrado em: $MAIN_JS_PATH"
              echo "üîÑ Copiando para dist/main.js..."
              
              # Criar dist/main.js a partir do arquivo encontrado
              cp "$MAIN_JS_PATH" "dist/main.js"
              echo "‚úÖ dist/main.js criado"
            else
              echo "‚ùå ERRO CR√çTICO: main.js n√£o encontrado em lugar nenhum!"
              echo "üìÅ Listando conte√∫do de dist:"
              find dist -type f -name "*.js" | head -20
              exit 1
            fi
          fi
          
          # Verifica√ß√£o final
          echo "‚úÖ Build conclu√≠do com sucesso!"
          echo "üìÅ Estrutura final do dist:"
          ls -la dist/
          echo "üìÑ Main.js na raiz: $(ls -la dist/main.js 2>/dev/null || echo 'N√ÉO ENCONTRADO')"
        env:
          NODE_ENV: production

      - name: Configure API to listen on all interfaces
        run: |
          echo "üîß Configurando API para escutar em 0.0.0.0..."
          
          if [ ! -f "src/main.ts" ]; then
            echo "‚ö†Ô∏è src/main.ts n√£o encontrado"
            exit 0
          fi
          
          # Backup do arquivo original
          cp src/main.ts src/main.ts.backup
          
          # Modificar para escutar em 0.0.0.0
          sed -i "s/await app\.listen(port, '0\.0\.0\.0')/await app.listen(port)/g" src/main.ts
          sed -i "s/await app\.listen(port)/await app.listen(port, '0.0.0.0')/g" src/main.ts
          
          echo "‚úÖ main.ts modificado"
          echo "üìÑ Verifica√ß√£o:"
          grep -n "listen" src/main.ts

      - name: Create PM2 ecosystem file
        run: |
          echo "üìÑ Criando ecosystem.config.js..."
          cat > ecosystem.config.js << 'EOF'
          module.exports = {
            apps: [{
              name: 'app',
              script: './dist/main.js',
              instances: 1,
              autorestart: true,
              watch: false,
              max_memory_restart: '500M',
              env: {
                NODE_ENV: 'production',
                PORT: 3000
              },
              error_file: '/var/log/app-error.log',
              out_file: '/var/log/app-out.log',
              time: true
            }]
          }
          EOF
          
          echo "‚úÖ ecosystem.config.js criado"

      - name: Prepare deployment package
        run: |
          echo "üì¶ Preparando pacote de deploy..."
          
          rm -rf deploy-package
          mkdir -p deploy-package
          
          # Copiar dist (com estrutura correta)
          cp -r dist deploy-package/
          
          # Copiar package files
          cp package.json deploy-package/
          cp package-lock.json deploy-package/
          
          # Copiar ecosystem.config.js
          cp ecosystem.config.js deploy-package/
          
          # Copiar outros arquivos necess√°rios
          [ -f ".env.example" ] && cp .env.example deploy-package/
          [ -f "nest-cli.json" ] && cp nest-cli.json deploy-package/
          
          echo "üìÅ Estrutura do deploy-package:"
          ls -la deploy-package/

      - name: Configure SSH key
        run: |
          echo "üîë Configurando chave SSH..."
          
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          
          # Corrigir formata√ß√£o
          sed -i 's/\\n/\n/g' ~/.ssh/deploy_key
          sed -i 's/\r$//' ~/.ssh/deploy_key
          
          # Garantir formato PEM
          if ! head -1 ~/.ssh/deploy_key | grep -q "BEGIN"; then
            echo "-----BEGIN RSA PRIVATE KEY-----" > ~/.ssh/deploy_key.tmp
            cat ~/.ssh/deploy_key >> ~/.ssh/deploy_key.tmp
            mv ~/.ssh/deploy_key.tmp ~/.ssh/deploy_key
          fi
          
          if ! tail -1 ~/.ssh/deploy_key | grep -q "END"; then
            echo "-----END RSA PRIVATE KEY-----" >> ~/.ssh/deploy_key
          fi
          
          echo "" >> ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          
          echo "‚úÖ Chave SSH configurada"

      - name: Test SSH connection
        run: |
          echo "üîå Testando conex√£o SSH..."
          
          # Testar porta
          timeout 3 nc -z -w 2 "$SSH_HOST" "$SSH_PORT" || echo "‚ö†Ô∏è Teste de porta falhou, continuando..."
          
          # Testar SSH
          ssh -o StrictHostKeyChecking=no \
              -o ConnectTimeout=5 \
              -i ~/.ssh/deploy_key \
              "$SSH_USER@$SSH_HOST" \
              "echo '‚úÖ SSH OK'"

      - name: Deploy to EC2
        run: |
          echo "üöÄ INICIANDO DEPLOY"
          
          # 1. Preparar diret√≥rio
          ssh -o StrictHostKeyChecking=no \
              -i ~/.ssh/deploy_key \
              "$SSH_USER@$SSH_HOST" \
              "sudo mkdir -p $APP_DIR && \
               sudo chown -R $SSH_USER:$SSH_USER $APP_DIR"
          
          # 2. Enviar arquivos
          echo "üì§ Enviando arquivos..."
          rsync -avz \
            -e "ssh -o StrictHostKeyChecking=no -i ~/.ssh/deploy_key" \
            deploy-package/ \
            "$SSH_USER@$SSH_HOST:$APP_DIR/"
          
          # 3. VERIFICAR arquivos no EC2
          echo "üîç Verificando arquivos no EC2..."
          ssh -o StrictHostKeyChecking=no \
              -i ~/.ssh/deploy_key \
              "$SSH_USER@$SSH_HOST" \
              "echo 'üìÅ Estrutura em $APP_DIR:'; \
               ls -la $APP_DIR/; \
               echo ''; \
               if [ -f '$APP_DIR/dist/main.js' ]; then \
                 echo '‚úÖ dist/main.js encontrado!'; \
               else \
                 echo '‚ùå dist/main.js N√ÉO encontrado!'; \
                 exit 1; \
               fi"
          
          # 4. INSTALAR E CONFIGURAR NO EC2
          echo "‚öôÔ∏è Configurando aplica√ß√£o no EC2..."
          ssh -o StrictHostKeyChecking=no \
              -i ~/.ssh/deploy_key \
              "$SSH_USER@$SSH_HOST" \
              "set -e
               cd $APP_DIR
               
               echo 'üì¶ Instalando depend√™ncias...'
               npm ci --only=production --silent
               
               echo 'üöÄ Iniciando PM2...'
               
               # Parar inst√¢ncia existente
               pm2 delete app 2>/dev/null || true
               
               # Iniciar nova inst√¢ncia
               if [ -f 'ecosystem.config.js' ]; then
                 pm2 start ecosystem.config.js
               else
                 pm2 start dist/main.js --name 'app'
               fi
               
               pm2 save
               
               echo '‚úÖ Aplica√ß√£o iniciada com PM2!'"
          
          echo ""
          echo "üéâ DEPLOY CONCLU√çDO!"
          echo "üì° Aplica√ß√£o dispon√≠vel em: http://$SSH_HOST:3000"

      - name: Cleanup
        run: |
          rm -f ~/.ssh/deploy_key
          rm -rf deploy-package
          [ -f "src/main.ts.backup" ] && mv src/main.ts.backup src/main.ts